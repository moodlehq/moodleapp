---
phase: 01-non-conflict-merge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Upstream v5.1.0 changes are merged into branch"
    - "Non-conflict files contain upstream code"
    - "Conflict files preserve our customizations (via -X ours)"
    - "Merge commit exists in git history"
  artifacts:
    - path: ".git/MERGE_HEAD"
      provides: "Merge in progress or completed"
      note: "Will not exist after commit - that's correct"
  key_links:
    - from: "upstream/latest"
      to: "latest branch"
      via: "git merge -X ours"
      pattern: "Merge branch 'latest' of.*upstream"
---

<objective>
Merge upstream Moodle App v5.1.0 into our branch, automatically accepting our version for any conflicts.

Purpose: Get 2,362+ upstream file changes into our codebase while preserving our custom code in conflict files. This is a bulk merge - the app will NOT build after this phase (expected behavior).

Output: A merge commit combining upstream changes with our customizations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fetch latest upstream and execute merge</name>
  <files>None - git operations only</files>
  <action>
    1. Fetch the latest from upstream remote:
       `git fetch upstream`

    2. Execute the merge with -X ours strategy:
       `git merge upstream/latest -X ours -m "Merge upstream v5.1.0 with Aspire customizations"`

       The -X ours flag means: for any file with conflicts, automatically
       accept our version. This preserves all 47 conflict files with our
       code intact. The 2,362+ non-conflict files get upstream changes.

    3. If merge fails for any reason other than conflicts (e.g., dirty working
       tree), stage and commit current changes first, then retry.
  </action>
  <verify>
    Run: `git log --oneline -1`
    Output should show a merge commit message containing "Merge upstream" or "upstream/latest"

    Run: `git diff --stat HEAD~1..HEAD | tail -5`
    Should show many files changed (2000+)
  </verify>
  <done>
    - Merge commit exists in git history
    - `git status` shows clean working tree (nothing to commit)
    - Upstream changes are incorporated into non-conflict files
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify merge state</name>
  <files>None - verification only</files>
  <action>
    Verify the merge completed correctly by checking:

    1. The merge commit exists:
       `git log --oneline -1` should show merge commit

    2. Count files changed in the merge:
       `git diff --stat HEAD~1..HEAD | wc -l`
       Should show 2000+ lines (each line is a file)

    3. Verify a known conflict file still has our code:
       Check src/core/singletons/url.ts contains our YouTube proxy logic
       (search for "youtube-proxy" or similar Aspire-specific patterns)

    4. Verify a known non-conflict file has upstream changes:
       Check package.json has been updated (version should reflect 5.1.0)
  </action>
  <verify>
    Run: `git log --oneline -3`
    First commit should be merge commit

    Run: `grep -l "youtube-proxy\|aspireparent\|Aspire" src/core/singletons/url.ts | wc -l`
    Should return 1 (our customizations preserved)
  </verify>
  <done>
    - Merge commit confirmed in history
    - 2000+ files changed in merge
    - Conflict files retain our customizations
    - Non-conflict files have upstream content
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `git log --oneline -1` shows merge commit
2. `git status` shows clean working tree
3. `git diff --stat HEAD~1..HEAD | wc -l` shows 2000+ files changed
4. `grep "aspireparent\|youtube-proxy" src/core/singletons/url.ts` finds our code

Note: The app will NOT build at this point. This is expected.
Phase 2 will adapt the conflict files to work with the new upstream APIs.
</verification>

<success_criteria>
- MRG-01: Merge command executes successfully
- MRG-02: No fatal git errors during merge
- MRG-03: Merge commit exists in git history
- Conflict files (47) preserve our customizations
- Non-conflict files (2362+) have upstream changes
</success_criteria>

<output>
After completion, create `.planning/phases/01-non-conflict-merge/01-01-SUMMARY.md`
</output>
