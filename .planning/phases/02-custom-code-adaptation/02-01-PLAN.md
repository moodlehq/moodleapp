---
phase: 02-custom-code-adaptation
plan: 01
type: code
wave: 1
depends_on: []
files_modified:
  - src/core/singletons/url.ts
  - src/core/singletons/iframe.ts
  - src/core/directives/format-text.ts
  - src/app/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Core singletons compile without TypeScript errors"
    - "Import paths use new @services/overlays/* pattern"
    - "app.module.ts bootstraps successfully"
  artifacts:
    - path: "src/core/singletons/url.ts"
      provides: "CoreUrl singleton with YouTube proxy and maps URL support"
    - path: "src/core/singletons/iframe.ts"
      provides: "CoreIframe singleton with correct overlay imports"
    - path: "src/app/app.module.ts"
      provides: "Root Angular module with all imports"
---

<objective>
Update core services to use new Angular 20 / Moodle v5.1.0 import paths and APIs.

Purpose: These are foundational singletons and modules that other components depend on. Fixing these first ensures imports work across the codebase.

Output: Core services compile without errors, ready for downstream components.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-custom-code-adaptation/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix iframe.ts imports</name>
  <files>src/core/singletons/iframe.ts</files>
  <action>
    1. Read iframe.ts and verify import paths are correct
    2. The file should already have correct imports based on research:
       - `import { CoreLoadings } from '@services/overlays/loadings';`
       - `import { CoreAlerts } from '@services/overlays/alerts';`
    3. If any imports use old paths like `@services/loadings`, update to `@services/overlays/loadings`
    4. Verify CorePromiseUtils is imported from `@singletons/promise-utils`

    Expected current state (verified correct):
    ```typescript
    import { CoreLoadings } from '@services/overlays/loadings';
    import { CoreAlerts } from '@services/overlays/alerts';
    ```

    No changes expected if file is already compliant.
  </action>
  <verify>
    Run: `npx tsc --noEmit src/core/singletons/iframe.ts 2>&1 | head -20`
    Should show no import-related errors for overlay services.
  </verify>
  <done>
    - iframe.ts uses @services/overlays/* import paths
    - No TypeScript errors related to missing imports
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify url.ts and format-text.ts compatibility</name>
  <files>src/core/singletons/url.ts, src/core/directives/format-text.ts</files>
  <action>
    1. Read url.ts - research indicates it's already compatible with v5.1.0:
       - Has CoreUrlAddParamsOptions interface
       - Has buildMapsURL() method
       - Has isYoutubeURL() method
       - Contains Aspire YouTube proxy customizations

    2. Read format-text.ts - research indicates it's already using Angular 17+ patterns:
       - Uses viewChild() signal pattern
       - Uses input() for inputs
       - Uses effect() for reactivity
       - Imports CoreAlerts from @services/overlays/alerts

    3. If any issues found, fix import paths to use new overlay patterns:
       - Old: `@services/loadings` -> New: `@services/overlays/loadings`
       - Old: `@services/alerts` -> New: `@services/overlays/alerts`

    No changes expected if files are already compliant.
  </action>
  <verify>
    Run: `npx tsc --noEmit src/core/singletons/url.ts src/core/directives/format-text.ts 2>&1 | head -20`
  </verify>
  <done>
    - url.ts preserves YouTube proxy and maps URL customizations
    - format-text.ts uses Angular 17+ signal patterns
    - Both files have no TypeScript import errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify app.module.ts compatibility</name>
  <files>src/app/app.module.ts</files>
  <action>
    1. Read app.module.ts and verify it has proper structure:
       - BrowserModule, BrowserAnimationsModule imports
       - IonicModule.forRoot() with navAnimation
       - HttpClientModule for JSON requests
       - TranslateModule.forRoot() with loader
       - CoreModule, AddonsModule imports
       - RouteReuseStrategy provider
       - APP_INITIALIZER for cron delegate

    2. Verify the debug console import is present:
       ```typescript
       // Initialize debug console capture early
       import '@services/debug-console';
       ```

    3. No changes expected - file should already be compatible based on research showing it was kept via -X ours merge strategy and appears functional.
  </action>
  <verify>
    Run: `npx tsc --noEmit src/app/app.module.ts 2>&1 | head -20`
  </verify>
  <done>
    - app.module.ts has all required imports
    - Debug console import is present
    - No TypeScript errors
  </done>
</task>

</tasks>

<verification>
Run full TypeScript check on core services:
```bash
npx tsc --noEmit \
  src/core/singletons/url.ts \
  src/core/singletons/iframe.ts \
  src/core/directives/format-text.ts \
  src/app/app.module.ts \
  2>&1 | grep -E "(error|Error)" | head -20
```

All files should compile without import-related errors.
</verification>

<success_criteria>
- SVC-01: url.ts has correct CoreUrl.addParamsToUrl signature (verified)
- SVC-02: iframe.ts uses @services/overlays/loadings import path
- SVC-03: format-text.ts uses Angular 17+ patterns (signals, effects)
- SVC-04: app.module.ts compiles and has debug console import
- All Aspire customizations preserved (YouTube proxy, debug console)
</success_criteria>

<output>
After completion, create `.planning/phases/02-custom-code-adaptation/02-01-SUMMARY.md`
</output>
