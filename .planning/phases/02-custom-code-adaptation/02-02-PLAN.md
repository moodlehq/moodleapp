---
phase: 02-custom-code-adaptation
plan: 02
type: code
wave: 2
depends_on: [02-01]
files_modified:
  - src/core/features/mainmenu/components/user-menu/user-menu.ts
  - src/core/features/mainmenu/components/user-menu/user-menu.html
  - src/core/features/mainmenu/components/user-menu/user-menu.scss
autonomous: true

must_haves:
  truths:
    - "User menu compiles without TypeScript errors"
    - "Parent/mentee system code is preserved and functional"
    - "Debug console 7-tap easter egg works"
    - "App version and build info displays correctly"
    - "Dynamic app links from Moodle course work"
  artifacts:
    - path: "src/core/features/mainmenu/components/user-menu/user-menu.ts"
      provides: "User menu component with parent features, debug console, app links"
      exports: ["CoreMainMenuUserMenuComponent"]
  key_links:
    - from: "user-menu.ts"
      to: "@features/user/constants"
      via: "CORE_USER_PROFILE_REFRESHED import"
      pattern: "CORE_USER_PROFILE_REFRESHED"
    - from: "user-menu.ts"
      to: "@services/overlays/alerts"
      via: "CoreAlerts import"
      pattern: "CoreAlerts"
---

<objective>
Fix user-menu.ts import issues and update to new v5.1.0 APIs while preserving all Aspire customizations.

Purpose: The user menu is critical for parent/mentee system, debug console access, and app links. It has multiple missing imports that will cause build failures.

Output: User menu compiles and all custom features (parent switching, debug tap, app links) work.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-custom-code-adaptation/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix constant and service imports in user-menu.ts</name>
  <files>src/core/features/mainmenu/components/user-menu/user-menu.ts</files>
  <action>
    Fix the following import issues identified in research:

    1. **Fix USER_PROFILE_REFRESHED constant** (lines ~22, 625, 675):
       Change:
       ```typescript
       import { CoreUser, CoreUserProfile, USER_PROFILE_REFRESHED } from '@features/user/services/user';
       ```
       To:
       ```typescript
       import { CoreUser, CoreUserProfile } from '@features/user/services/user';
       import { CORE_USER_PROFILE_REFRESHED } from '@features/user/constants';
       ```

       Then update all usages:
       - Line ~625: `CoreEvents.trigger(USER_PROFILE_REFRESHED, ...)` -> `CoreEvents.trigger(CORE_USER_PROFILE_REFRESHED, ...)`
       - Line ~675: Same change

    2. **Add missing CoreSiteLogoComponent import** (used in component imports array):
       Add:
       ```typescript
       import { CoreSiteLogoComponent } from '@components/site-logo/site-logo';
       ```

    3. **Add missing CoreAlerts import** (used for confirmDelete):
       Add:
       ```typescript
       import { CoreAlerts } from '@services/overlays/alerts';
       ```

    4. **Add missing CoreLoginHelper import** (used for goToAddSite):
       Add:
       ```typescript
       import { CoreLoginHelper } from '@features/login/services/login-helper';
       ```

    5. **Add missing CoreUtils import** (used for openInBrowser):
       Add:
       ```typescript
       import { CoreUtils } from '@services/utils/utils';
       ```

    6. **Add missing CoreSite type import** (used in loadSiteLogo method):
       Add:
       ```typescript
       import { CoreSite } from '@classes/sites/site';
       ```

    Preserve ALL existing Aspire customizations:
    - Parent/mentee system (isParentUser, mentees, selectMentee, clearMenteeSelection)
    - Debug console (debugTapCount, onBuildNumberTap)
    - App links (appLinkSections, loadAppLinks, openAppLink)
    - Build info (appVersion, buildNumber, buildTime)
  </action>
  <verify>
    Run: `npx tsc --noEmit src/core/features/mainmenu/components/user-menu/user-menu.ts 2>&1 | head -30`
    Should show no "Cannot find module" or "Cannot find name" errors.
  </verify>
  <done>
    - USER_PROFILE_REFRESHED replaced with CORE_USER_PROFILE_REFRESHED from @features/user/constants
    - All missing imports added (CoreSiteLogoComponent, CoreAlerts, CoreLoginHelper, CoreUtils, CoreSite)
    - No TypeScript import errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify user-menu.html template compatibility</name>
  <files>src/core/features/mainmenu/components/user-menu/user-menu.html</files>
  <action>
    1. Read user-menu.html and verify:
       - Template references match component properties
       - core-site-logo component is used (matches CoreSiteLogoComponent import)
       - Parent/mentee section template exists with mentee selector
       - Debug tap handler is on build number element
       - App links section exists with dynamic sections

    2. No changes expected if template matches component class.
       Template should have:
       - `(click)="onBuildNumberTap()"` on build number element
       - Mentee selector with `*ngIf="isParentUser && mentees.length > 0"`
       - App links section with `*ngFor="let section of appLinkSections"`
  </action>
  <verify>
    Read the template file and verify all referenced methods and properties exist in component class.
  </verify>
  <done>
    - Template references valid component properties and methods
    - Parent/mentee UI elements present
    - Debug tap and app links sections present
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify user-menu.scss styling</name>
  <files>src/core/features/mainmenu/components/user-menu/user-menu.scss</files>
  <action>
    1. Read user-menu.scss and verify:
       - Styles for parent/mentee selector exist
       - Styles for app links sections exist
       - No deprecated SCSS syntax

    2. No changes expected - SCSS should be compatible.
       Key sections to verify exist:
       - `.mentee-selector` or similar for parent view
       - `.app-links-section` or similar for dynamic links
  </action>
  <verify>
    SCSS should compile without errors (will be tested during full build).
  </verify>
  <done>
    - SCSS has styles for all custom UI elements
    - No deprecated syntax
  </done>
</task>

</tasks>

<verification>
Run TypeScript check on user-menu component:
```bash
npx tsc --noEmit src/core/features/mainmenu/components/user-menu/user-menu.ts 2>&1 | head -30
```

Verify CORE_USER_PROFILE_REFRESHED is properly imported:
```bash
grep -n "CORE_USER_PROFILE_REFRESHED\|USER_PROFILE_REFRESHED" src/core/features/mainmenu/components/user-menu/user-menu.ts
```

Should show CORE_USER_PROFILE_REFRESHED only (not the old constant name).
</verification>

<success_criteria>
- USR-01: Parent/mentee system code preserved (isParentUser, selectMentee, clearMenteeSelection)
- USR-02: Debug console functionality preserved (onBuildNumberTap, 7-tap easter egg)
- USR-03: App version/build display preserved
- USR-04: App links feature preserved (loadAppLinks, openAppLink)
- USR-05: Imports updated to new service paths
- USR-06: Component compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-custom-code-adaptation/02-02-SUMMARY.md`
</output>
