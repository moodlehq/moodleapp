<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button [text]="'core.back' | translate"></ion-back-button>
        </ion-buttons>
        <ion-title>
            <h1>{{ 'core.news.allnews' | translate }}</h1>
        </ion-title>
    </ion-toolbar>
</ion-header>

<ion-content>
    <ion-refresher slot="fixed" [disabled]="!loaded" (ionRefresh)="refreshNews($event.target)">
        <ion-refresher-content pullingText="{{ 'core.pulltorefresh' | translate }}" />
    </ion-refresher>

    <core-loading [hideUntil]="loaded">
        <core-empty-box *ngIf="loaded && news.length === 0"
                        icon="fas-bullhorn"
                        [message]="'core.news.nonews' | translate">
        </core-empty-box>

        <div *ngIf="news.length > 0" class="news-container">
            <!-- VIEW TOGGLE -->
            <div class="view-toggle">
                <ion-segment [(ngModel)]="viewMode" (ionChange)="onViewModeChange()">
                    <ion-segment-button value="grouped">
                        <ion-label>
                            <ion-icon name="layers-outline"></ion-icon>
                            Grouped
                        </ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="timeline">
                        <ion-label>
                            <ion-icon name="calendar-outline"></ion-icon>
                            Timeline
                        </ion-label>
                    </ion-segment-button>
                    <ion-segment-button value="all">
                        <ion-label>
                            <ion-icon name="list-outline"></ion-icon>
                            All News
                        </ion-label>
                    </ion-segment-button>
                </ion-segment>
            </div>

            <!-- GROUPED VIEW - NEW COMPACT NAVIGATION -->
            <div class="news-grouped-view" *ngIf="viewMode === 'grouped'">
                <!-- Breadcrumb Navigation -->
                <div class="category-breadcrumb" *ngIf="currentPath.length > 0">
                    <div class="breadcrumb-track">
                        <button class="breadcrumb-item home" (click)="navigateToRoot()">
                            <ion-icon name="home-outline"></ion-icon>
                        </button>
                        <ng-container *ngFor="let crumb of currentPath; let i = index; let last = last">
                            <ion-icon name="chevron-forward" class="breadcrumb-separator"></ion-icon>
                            <button class="breadcrumb-item"
                                    [class.active]="last"
                                    (click)="navigateToBreadcrumb(i)">
                                {{ crumb.name }}
                            </button>
                        </ng-container>
                    </div>
                </div>

                <!-- Subcategory Chips -->
                <div class="subcategory-chips" *ngIf="currentSubcategories.length > 0">
                    <div class="chips-track">
                        <button class="subcategory-chip"
                                *ngFor="let subcat of currentSubcategories"
                                (click)="navigateToCategory(subcat)">
                            <ion-icon name="folder-outline"></ion-icon>
                            <span class="chip-name">{{ subcat.name }}</span>
                            <span class="chip-count">{{ countTotalNewsItems(subcat) }}</span>
                            <ion-icon name="chevron-forward" class="chip-arrow"></ion-icon>
                        </button>
                    </div>
                </div>

                <!-- Current Category News Items -->
                <div class="category-news-section" *ngIf="currentNewsItems.length > 0">
                    <div class="section-header" *ngIf="currentPath.length > 0">
                        <span class="section-label">
                            <ion-icon name="newspaper-outline"></ion-icon>
                            {{ currentPath[currentPath.length - 1]?.name || 'All' }} News
                        </span>
                        <span class="section-count">{{ currentNewsItems.length }} items</span>
                    </div>

                    <div class="news-items-list">
                        <div class="news-card-item" *ngFor="let item of currentNewsItems" (click)="openNewsItem(item)">
                            <div class="card-accent"></div>
                            <div class="card-body">
                                <div class="card-header">
                                    <div class="author-avatar" *ngIf="item.userpictureurl">
                                        <img [src]="item.userpictureurl"
                                             [alt]="item.userfullname"
                                             core-external-content
                                             onError="this.src='assets/img/user-avatar.png'">
                                    </div>
                                    <div class="card-meta">
                                        <h4 class="card-title">{{ item.subject }}</h4>
                                        <div class="meta-row">
                                            <span class="course-tag">{{ item.courseFullname }}</span>
                                            <span class="date-text">{{ formatDate(item.created) }}</span>
                                        </div>
                                    </div>
                                    <ion-icon *ngIf="item.pinned" name="pin" class="pin-badge"></ion-icon>
                                </div>
                                <div class="card-preview">
                                    <p [innerHTML]="item.message | coreNoTags"></p>
                                </div>
                                <div class="card-footer">
                                    <div class="footer-left">
                                        <span class="author-name">
                                            <ion-icon name="person-outline"></ion-icon>
                                            {{ item.userfullname }}
                                        </span>
                                        <div class="reply-count" *ngIf="item.numreplies > 0">
                                            <ion-icon name="chatbubbles-outline"></ion-icon>
                                            <span>{{ item.numreplies }}</span>
                                        </div>
                                    </div>
                                    <div class="read-more-indicator">
                                        <span>Read more</span>
                                        <ion-icon name="arrow-forward"></ion-icon>
                                    </div>
                                </div>
                            </div>
                            <div class="unread-badge" *ngIf="item.numunread > 0">{{ item.numunread }} new</div>
                        </div>
                    </div>
                </div>

                <!-- Empty State for Current Category -->
                <div class="empty-category" *ngIf="currentNewsItems.length === 0 && currentSubcategories.length === 0">
                    <ion-icon name="folder-open-outline"></ion-icon>
                    <p>No announcements in this category</p>
                    <button class="back-button" (click)="navigateToRoot()">
                        <ion-icon name="arrow-back"></ion-icon>
                        Go back to all categories
                    </button>
                </div>

                <!-- Root Level: Show All Top-Level Categories -->
                <div class="root-categories" *ngIf="currentPath.length === 0">
                    <div class="root-header">
                        <ion-icon name="library-outline"></ion-icon>
                        <span>Browse by Category</span>
                    </div>
                    <div class="category-grid">
                        <button class="category-tile"
                                *ngFor="let cat of categoryTree; let i = index"
                                [attr.data-index]="i"
                                (click)="navigateToCategory(cat)">
                            <div class="tile-icon">
                                <ion-icon name="folder-outline"></ion-icon>
                            </div>
                            <div class="tile-info">
                                <h5>{{ cat.name }}</h5>
                                <span>{{ countTotalNewsItems(cat) }} announcements</span>
                            </div>
                            <ion-icon name="chevron-forward" class="tile-arrow"></ion-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TIMELINE VIEW -->
            <div class="news-timeline-view" *ngIf="viewMode === 'timeline'">
                <div class="timeline-container">
                    <div class="timeline-month" *ngFor="let month of getTimelineMonths()">
                        <h3 class="month-header">{{ month.name }}</h3>
                        <div class="timeline-items">
                            <div class="timeline-item" *ngFor="let item of month.items" (click)="openNewsItem(item)">
                                <div class="timeline-date">
                                    <span class="day">{{ item.created * 1000 | date:'d' }}</span>
                                    <span class="weekday">{{ item.created * 1000 | date:'EEE' }}</span>
                                </div>
                                <div class="timeline-content">
                                    <div class="content-header">
                                        <h4>{{ item.subject }}</h4>
                                        <span class="course-badge">{{ item.courseName }}</span>
                                    </div>
                                    <p class="content-preview" [innerHTML]="item.message | coreNoTags"></p>
                                    <div class="content-footer">
                                        <span class="author">{{ item.userfullname }}</span>
                                        <div class="read-more">
                                            <span>Read</span>
                                            <ion-icon name="arrow-forward"></ion-icon>
                                        </div>
                                    </div>
                                </div>
                                <div class="timeline-connector"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ALL NEWS VIEW -->
            <div class="news-all-view" *ngIf="viewMode === 'all'">
                <div class="news-grid">
                    <div class="news-card" *ngFor="let item of news" (click)="openNewsItem(item)">
                        <div class="card-header">
                            <div class="header-left">
                                <img *ngIf="item.userpictureurl"
                                     [src]="item.userpictureurl"
                                     [alt]="item.userfullname"
                                     class="user-avatar"
                                     core-external-content
                                     onError="this.src='assets/img/user-avatar.png'">
                                <div class="header-info">
                                    <h3>{{ item.subject }}</h3>
                                    <div class="meta">
                                        <span class="course">{{ item.courseFullname }}</span>
                                        <span class="date">{{ formatDate(item.created) }}</span>
                                    </div>
                                </div>
                            </div>
                            <ion-icon *ngIf="item.pinned" name="pin" class="pin-icon"></ion-icon>
                        </div>
                        <div class="card-content">
                            <p [innerHTML]="item.message | coreNoTags"></p>
                        </div>
                        <div class="card-footer">
                            <div class="author">
                                <ion-icon name="person-outline"></ion-icon>
                                <span>{{ item.userfullname }}</span>
                            </div>
                            <div class="read-action">
                                <span>Read more</span>
                                <ion-icon name="arrow-forward"></ion-icon>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </core-loading>
</ion-content>

<!-- News Detail Modal -->
<ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()" class="news-detail-modal">
    <ng-template>
        <ion-content class="ion-padding" *ngIf="selectedNewsItem">
            <div class="modal-news-content">
                <!-- Header row: Close button + Author info -->
                <div class="modal-header-row">
                    <button class="modal-close-btn" (click)="closeModal()">
                        <ion-icon name="close"></ion-icon>
                    </button>
                    <div class="author-avatar" *ngIf="selectedNewsItem.userpictureurl">
                        <img [src]="selectedNewsItem.userpictureurl"
                             [alt]="selectedNewsItem.userfullname"
                             core-external-content
                             onError="this.src='assets/img/user-avatar.png'">
                    </div>
                    <div class="author-details">
                        <span class="author-name">{{ selectedNewsItem.userfullname }}</span>
                        <div class="author-meta">
                            <span class="post-date">{{ formatFullDate(selectedNewsItem.created) }}</span>
                            <span class="announcement-badge">Announcement</span>
                        </div>
                    </div>
                    <ion-icon *ngIf="selectedNewsItem.pinned" name="pin" class="pinned-icon"></ion-icon>
                </div>

                <!-- Course/Forum badges -->
                <div class="modal-badges">
                    <span class="course-badge">
                        <ion-icon name="school-outline"></ion-icon>
                        {{ selectedNewsItem.courseFullname }}
                    </span>
                    <span class="forum-badge" *ngIf="selectedNewsItem.forumName">
                        <ion-icon name="chatbubbles-outline"></ion-icon>
                        {{ selectedNewsItem.forumName }}
                    </span>
                </div>

                <!-- Title -->
                <h1 class="modal-title">{{ selectedNewsItem?.subject }}</h1>

                <!-- Full message content -->
                <div class="modal-body" [innerHTML]="selectedNewsItem?.message"></div>

                <!-- Footer with stats -->
                <div class="modal-footer" *ngIf="selectedNewsItem?.numreplies && selectedNewsItem.numreplies > 0">
                    <div class="reply-info">
                        <ion-icon name="chatbubble-outline"></ion-icon>
                        <span>{{ selectedNewsItem?.numreplies }} {{ selectedNewsItem?.numreplies === 1 ? 'reply' : 'replies' }}</span>
                    </div>
                </div>
            </div>
        </ion-content>
    </ng-template>
</ion-modal>
