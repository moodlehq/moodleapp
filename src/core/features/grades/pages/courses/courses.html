<ion-header>
    <ion-toolbar>
        <ion-buttons slot="start">
            <ion-back-button [text]="'core.back' | translate" />
        </ion-buttons>
        <ion-title>
            <h1>{{ 'core.grades.grades' | translate }}</h1>
        </ion-title>
        <ion-buttons slot="end">
            <ion-button
                fill="clear"
                [routerLink]="['/main/home/grades-courses-debug']"
            >
                <ion-icon name="bug-outline" slot="icon-only"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>
<ion-content>
    <core-split-view>
        <ion-refresher
            slot="fixed"
            [disabled]="!courses.loaded && !parentDataLoaded"
            (ionRefresh)="refreshCourses($event.target)"
        >
            <ion-refresher-content
                pullingText="{{ 'core.pulltorefresh' | translate }}"
            />
        </ion-refresher>
        <core-loading
            [hideUntil]="courses.loaded || (isParentView && parentDataLoaded)"
        >
            <core-empty-box
                *ngIf="courses.empty && !isParentView"
                icon="fas-chart-bar"
                [message]="'core.grades.nogradesreturned' | translate"
            />
            <core-empty-box
                *ngIf="isParentView && (!mentees || mentees.length === 0)"
                icon="fas-users"
                [message]="'No mentees found' | translate"
            />

            <!-- Loading message for parent view -->
            <div
                *ngIf="isParentView && !parentDataLoaded && mentees && mentees.length > 0"
                class="ion-padding ion-text-center"
            >
                <ion-spinner></ion-spinner>
                <p>Loading grades...</p>
            </div>

            <!-- Parent View: Modern Card Layout -->
            <div
                *ngIf="isParentView && mentees && mentees.length > 0 && parentDataLoaded"
                class="parent-grades-view"
            >
                <ng-container *ngIf="hasAnyCourses(); else noCoursesFound">
                    <!-- Mentee Section -->
                    <div class="mentee-section" *ngFor="let mentee of mentees">
                        <ng-container *ngIf="getCoursesForMentee(mentee.id).length > 0">
                            <!-- Mentee Header Card -->
                            <div class="mentee-header-card">
                                <div class="mentee-avatar">
                                    <ion-icon name="person"></ion-icon>
                                </div>
                                <div class="mentee-info">
                                    <h2>{{ mentee.fullname }}</h2>
                                    <p>{{ mentee.email }}</p>
                                </div>
                                <div class="mentee-stats">
                                    <span class="course-count">{{ getCoursesForMentee(mentee.id).length }}</span>
                                    <span class="course-label">Courses</span>
                                </div>
                            </div>

                            <!-- Course Cards Grid -->
                            <div class="courses-grid">
                                <div
                                    class="course-grade-card"
                                    *ngFor="let course of getCoursesForMentee(mentee.id)"
                                    (click)="selectCourseForMentee(course, mentee.id)"
                                >
                                    <div class="card-content">
                                        <div class="course-icon">
                                            <ion-icon name="school-outline"></ion-icon>
                                        </div>
                                        <div class="course-info">
                                            <h3>
                                                <core-format-text
                                                    [text]="course.courseFullName"
                                                    [contextInstanceId]="course.courseid"
                                                    contextLevel="course"
                                                />
                                            </h3>
                                        </div>
                                        <div class="grade-badge" *ngIf="course.grade && course.grade !== '-'">
                                            {{ course.grade }}
                                        </div>
                                    </div>
                                    <div class="card-arrow">
                                        <ion-icon name="chevron-forward"></ion-icon>
                                    </div>
                                </div>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <ng-template #noCoursesFound>
                    <core-empty-box
                        icon="fas-chart-bar"
                        [message]="'core.grades.nogradesreturned' | translate"
                    />
                </ng-template>
            </div>

            <!-- Student View: Enhanced Grade Overview -->
            <div *ngIf="!courses.empty && !isParentView" class="student-grades-view">

                <!-- Overall Performance Summary -->
                <div class="performance-summary-card">
                    <div class="summary-left">
                        <div class="summary-avatar">
                            <ion-icon name="school"></ion-icon>
                        </div>
                        <div class="summary-info">
                            <h2>My Grades</h2>
                            <p>{{ getTotalCourseCount() }} courses with grades</p>
                        </div>
                    </div>
                </div>

                <!-- Category Tree -->
                <div class="category-tree">
                    <ng-container *ngFor="let category of categoryTree">
                        <ng-container
                            *ngTemplateOutlet="categoryNode; context: { node: category, depth: 0 }"
                        ></ng-container>
                    </ng-container>
                </div>
            </div>

            <!-- Category Node Template -->
            <ng-template #categoryNode let-node="node" let-depth="depth">
                <!-- Category Header -->
                <ion-item-divider
                    [class.category-depth-1]="depth === 1"
                    [class.category-depth-2]="depth === 2"
                    [class.category-depth-3]="depth >= 3"
                    button
                    (click)="toggleCategory(node.id)"
                    *ngIf="node.courses.length > 0 || node.children.length > 0"
                >
                    <ion-icon
                        [name]="node.expanded ? 'chevron-down' : 'chevron-forward'"
                        slot="start"
                        class="category-toggle-icon"
                    ></ion-icon>
                    <ion-label>
                        <h2>{{ node.name }}</h2>
                        <p *ngIf="node.courses.length > 0">
                            {{ node.courses.length }} course(s)
                        </p>
                    </ion-label>
                </ion-item-divider>

                <!-- Category Courses -->
                <div [hidden]="!node.expanded" class="category-content">
                    <div
                        *ngFor="let course of node.courses"
                        class="course-card"
                        [class.course-depth-1]="depth === 0"
                        [class.course-depth-2]="depth === 1"
                        [class.course-depth-3]="depth >= 2"
                        [class]="getGradeColorClass(course.grade)"
                        (click)="courses.select(course)"
                    >
                        <div class="course-card-left">
                            <div class="subject-icon">
                                <ion-icon [name]="getSubjectIcon(course.courseFullName)"></ion-icon>
                            </div>
                        </div>
                        <div class="course-card-center">
                            <h4 class="course-name">
                                <core-format-text
                                    [text]="course.courseFullName"
                                    [contextInstanceId]="course.courseid"
                                    contextLevel="course"
                                />
                            </h4>
                        </div>
                        <div class="course-card-right">
                            <div class="grade-circle">
                                <span class="grade-value">{{ course.grade }}</span>
                            </div>
                            <ion-icon name="chevron-forward" class="arrow-icon"></ion-icon>
                        </div>
                    </div>

                    <!-- Child Categories -->
                    <ng-container *ngFor="let child of node.children">
                        <ng-container
                            *ngTemplateOutlet="categoryNode; context: { node: child, depth: depth + 1 }"
                        ></ng-container>
                    </ng-container>
                </div>
            </ng-template>
        </core-loading>
    </core-split-view>
</ion-content>
