<ion-header class="aspire-user-menu-header"></ion-header>
<ion-content class="aspire-user-menu-content">
    <core-loading [hideUntil]="siteLogoLoaded && handlersLoaded">
        <!-- Profile Card -->
        <div class="aspire-profile-card" *ngIf="siteInfo">
            <!-- Background Pattern -->
            <div class="profile-card-bg">
                <div class="bg-pattern"></div>
                <div class="bg-gradient"></div>
            </div>

            <!-- Logout Button -->
            <button class="logout-btn" (click)="logout($event)">
                <ion-icon name="log-out-outline"></ion-icon>
            </button>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Avatar -->
                <div class="avatar-container">
                    <div class="avatar-ring">
                        <core-user-avatar
                            [site]="siteInfo"
                            [userId]="siteInfo.userid"
                            [linkProfile]="false"
                            class="profile-avatar"
                        />
                    </div>
                    <div class="avatar-badge" *ngIf="badgeCount > 0">
                        <ion-icon name="trophy"></ion-icon>
                    </div>
                </div>

                <!-- User Info -->
                <h2 class="user-name">{{ siteInfo.fullname }}</h2>
                <p class="user-email">{{ siteInfo.username }}</p>

                <!-- Student ID Badge -->
                <div class="id-badge" *ngIf="getSequenceValue()">
                    <ion-icon name="id-card-outline"></ion-icon>
                    <span>{{ getSequenceValue() }}</span>
                </div>

                <!-- Mentee Selector (Parents) -->
                <div class="mentee-selector" *ngIf="isParentUser && mentees.length > 0">
                    <button class="mentee-trigger" (click)="toggleMenteeSelector()">
                        <div class="mentee-icon">
                            <ion-icon name="people"></ion-icon>
                        </div>
                        <span class="mentee-label">
                            <small>{{ 'core.user.viewingas' | translate }}</small>
                            <strong *ngIf="!selectedMentee">{{ 'core.yourself' | translate }}</strong>
                            <strong *ngIf="selectedMentee">{{ getMenteeFirstWord() }}</strong>
                        </span>
                        <ion-icon name="chevron-down" class="mentee-arrow" [class.open]="showMenteeSelector"></ion-icon>
                    </button>

                    <div class="mentee-dropdown" [class.show]="showMenteeSelector">
                        <button class="mentee-option" (click)="clearMenteeSelection()" [class.active]="!selectedMenteeId">
                            <core-user-avatar [userId]="siteInfo.userid" [linkProfile]="false" />
                            <span>{{ 'core.yourself' | translate }}</span>
                            <ion-icon name="checkmark-circle" class="check-icon" *ngIf="!selectedMenteeId"></ion-icon>
                        </button>

                        <button class="mentee-option" *ngFor="let mentee of mentees"
                            (click)="selectMentee(mentee)"
                            [class.active]="selectedMenteeId === mentee.id">
                            <core-user-avatar [user]="mentee" [userId]="mentee.id" [linkProfile]="false" />
                            <span>{{ mentee.fullname }}</span>
                            <ion-icon name="checkmark-circle" class="check-icon" *ngIf="selectedMenteeId === mentee.id"></ion-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-icon">
                        <ion-icon name="book"></ion-icon>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">{{ courseCount || 0 }}</span>
                        <span class="stat-label">Courses</span>
                    </div>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                    <div class="stat-icon badges">
                        <ion-icon name="trophy"></ion-icon>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">{{ badgeCount || 0 }}</span>
                        <span class="stat-label">Badges</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Section (Dynamic from Moodle course) -->
        <div class="menu-section resources-section" *ngIf="appLinkSections.length > 0">
            <div class="section-header">
                <span class="section-title">School Resources</span>
                <div class="section-line"></div>
            </div>

            <!-- Dynamic sections from App Links course -->
            <div class="collapsible-group" *ngFor="let section of appLinkSections">
                <button class="collapsible-header" (click)="toggleAppSection(section.id)">
                    <div class="header-icon" [ngClass]="getIconClass(section.icon)">
                        <ion-icon [name]="section.icon"></ion-icon>
                    </div>
                    <span class="header-title">{{ section.name }}</span>
                    <ion-icon name="chevron-down" class="collapse-arrow" [class.open]="isSectionExpanded(section.id)"></ion-icon>
                </button>
                <div class="collapsible-content" [class.open]="isSectionExpanded(section.id)">
                    <ng-container *ngFor="let item of section.items">
                        <!-- Regular link or file -->
                        <button class="resource-item" *ngIf="item.type !== 'folder'" (click)="openAppLink($event, item)">
                            <span>{{ item.name }}</span>
                            <ion-icon [name]="item.icon || 'open-outline'"></ion-icon>
                        </button>

                        <!-- Folder with children -->
                        <div class="folder-group" *ngIf="item.type === 'folder'">
                            <button class="resource-item folder-header" (click)="toggleFolder(item.name)">
                                <ion-icon [name]="item.icon || 'folder-outline'" class="folder-icon"></ion-icon>
                                <span>{{ item.name }}</span>
                                <ion-icon name="chevron-down" class="folder-arrow" [class.open]="isFolderExpanded(item.name)"></ion-icon>
                            </button>
                            <div class="folder-content" [class.open]="isFolderExpanded(item.name)">
                                <button class="resource-item folder-item" *ngFor="let child of item.children" (click)="openAppLink($event, child)">
                                    <span>{{ child.name }}</span>
                                    <ion-icon [name]="child.icon || 'document-outline'"></ion-icon>
                                </button>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>

        <!-- Hidden original handlers for compatibility -->
        <ng-container *ngIf="false">
            <ion-item button *ngFor="let handler of handlers" class="ion-text-wrap"
                (click)="handlerClicked($event, handler)"
                [ngClass]="['core-user-menu-handler', handler.class || '']"
                [hidden]="handler.hidden" [attr.aria-label]="handler.title | translate" [detail]="true">
                <ion-icon *ngIf="handler.icon" [name]="handler.icon" slot="start" aria-hidden="true" />
                <ion-label><p class="item-heading">{{ handler.title | translate }}</p></ion-label>
                <ion-badge slot="end" *ngIf="handler.showBadge" [hidden]="handler.loading || !handler.badge" aria-hidden="true">{{handler.badge}}</ion-badge>
                <ion-spinner slot="end" *ngIf="handler.showBadge && handler.loading" [attr.aria-label]="'core.loading' | translate" />
            </ion-item>

            <ion-item button *ngFor="let handler of accountHandlers; let first = first"
                (click)="handlerClicked($event, handler)"
                [class]="['ion-text-wrap', 'core-user-account-menu-handler', handler.class]"
                [class.core-user-menu-separator]="first"
                [hidden]="handler.hidden" [attr.aria-label]="handler.title | translate" [detail]="true">
                <ion-icon *ngIf="handler.icon" [name]="handler.icon" slot="start" aria-hidden="true" />
                <ion-label><p class="item-heading">{{ handler.title | translate }}</p></ion-label>
                <ion-badge slot="end" *ngIf="handler.showBadge" [hidden]="handler.loading || !handler.badge" aria-hidden="true">{{handler.badge}}</ion-badge>
                <ion-spinner slot="end" *ngIf="handler.showBadge && handler.loading" [attr.aria-label]="'core.loading' | translate" />
            </ion-item>
        </ng-container>
    </core-loading>
</ion-content>

<ion-footer class="aspire-user-menu-footer">
    <!-- Social Media Links -->
    <div class="social-links">
        <span class="social-label">Connect With Us</span>
        <div class="social-icons">
            <button (click)="openExternalUrl($event, 'https://www.facebook.com/AspireinternationalSchool.Egypt')" class="social-icon facebook">
                <ion-icon name="logo-facebook"></ion-icon>
            </button>
            <button (click)="openExternalUrl($event, 'https://www.instagram.com/aspire.international.school.eg/')" class="social-icon instagram">
                <ion-icon name="logo-instagram"></ion-icon>
            </button>
            <button (click)="openExternalUrl($event, 'https://www.youtube.com/@aspireinternationalschool')" class="social-icon youtube">
                <ion-icon name="logo-youtube"></ion-icon>
            </button>
            <button (click)="openExternalUrl($event, 'https://www.linkedin.com/company/aspire-international-school')" class="social-icon linkedin">
                <ion-icon name="logo-linkedin"></ion-icon>
            </button>
            <button (click)="openExternalUrl($event, 'https://www.aspireschool.org/')" class="social-icon website">
                <ion-icon name="globe-outline"></ion-icon>
            </button>
        </div>
    </div>

    <div class="footer-actions">
        <button class="footer-btn contact" (click)="openContactUs($event)">
            <ion-icon name="headset-outline"></ion-icon>
            <span>Contact Us</span>
        </button>

        <button class="footer-btn switch" (click)="switchAccounts($event)" *ngIf="displaySwitchAccount">
            <ion-icon name="swap-horizontal-outline"></ion-icon>
            <span>{{ 'core.mainmenu.switchaccount' | translate }}</span>
        </button>
    </div>

    <div class="version-info">
        <span>v{{ appVersion }}</span>
        <span class="version-divider">•</span>
        <span class="build-number" (click)="onBuildNumberTap()">#{{ buildNumber }}</span>
        <span class="version-divider">•</span>
        <span class="build-time">{{ buildTime }}</span>
    </div>
</ion-footer>
